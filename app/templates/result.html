<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental X-ray Analysis</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', 'Roboto', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            color: black;
            background: #fff;
            font-family: 'Roboto', sans-serif;
            margin-left: 240px;
        }

         h1, h2, h3, h4 {
          font-family: 'Poppins', sans-serif;
          color: #007bff; 
      }

        p, li {
          font-family: 'Roboto', sans-serif;
          color: #007bff; 
      }
        
        section {
            margin: 40px 0;
        }
        
        section h2 {
            color: #007bff;
            margin-bottom: 10px;
            font-size: 45px;
            font-weight: bold;
        }

         h3{
            margin-top: 20px;
            font-size: 30px;
        }
        
        section p {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        input[type="file"] {
            margin: 15px 0;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            width: 100%;
            background-color: #ecf0f1;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin: 20px 0;
            border-bottom: 2px solid #ddd;
        }
        
        .tabs button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: black;
            transition: all 0.3s;
        }
        
        .tabs button.active {
            color: black;
            border-bottom: 3px solid #007bff;
        }
        
        .tabs button:hover {
            background-color: #007bff; 
            color: white; 
            border-radius: 5px; 
        }

        
        /* Main Content */
        main {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        main.active {
            display: grid;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            position: relative;
            border-left: 5px solid #3498db; 
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.2); 
            transform: translateY(-3px);
        }

        .card h3 {
            color: #007bff; 
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #3498db; 
            padding-bottom: 10px;
        }

        .card p {
            color: #34495e;
            margin-bottom: 15px;
        }

        .card ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .card li {
            margin-bottom: 10px;
            color: #000; 
        }

        /* Badges */
        .badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #3498db; 
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Buttons */
        button {
            padding: 10px 15px;
            background-color: #3498db; 
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            background-color: #2980b9; 
            transform: scale(1.05); 
        }

        
        #retakeBtn {
            background-color: #7f8c8d;
            width: 100%;
            margin-top: 15px;
        }
        
        #retakeBtn:hover {
            background-color: #95a5a6;
        }
        
        /* Image */
        img {
            max-width: 100%;
            border-radius: 5px;
            display: block;
        }
        
        /* JSON Output */
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin-top: 15px;
            font-size: 14px;
            border-left: 4px solid #3498db;
            color: #2c3e50;
            display: none;
        }

        /* Footer Button */
        .footer-btn {
            margin-top: 30px;
            text-align: center;
        }

        .footer-btn button {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #3498db; 
            border-radius: 8px;
            border: none;
            color: white;
            transition: background-color 0.3s, transform 0.2s;
        }

        .footer-btn button:hover {
            background-color: #2980b9; 
            transform: scale(1.05);
        }

        #detectionsContainer {
            max-height: 700px; /* Adjust this value as needed */
            overflow-y: auto;
            padding-right: 10px; /* Add some padding so scrollbar doesn't overlap content */
        }

        /* Custom scrollbar styling */
        #detectionsContainer::-webkit-scrollbar {
            width: 8px;
        }

        #detectionsContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #detectionsContainer::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        #detectionsContainer::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* For Firefox */
        #detectionsContainer {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }

        /* Detection cards */
        .detection-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
            padding: 18px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db; 
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .detection-card:hover {
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.2);
            transform: translateY(-3px);
        }

        .detection-card h4 {
            color: #007bff;
            margin-bottom: 10px;
        }

        .detection-card p {
            margin-bottom: 8px;
            color: #000; 
        }

        .confidence {
            display: inline-block;
            padding: 4px 10px;
            background-color: #ecf6ff; 
            border-radius: 12px;
            font-size: 12px;
            color: #007bff;
            font-weight: 500;
        }
      
        .types {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white; /* Better contrast with colored backgrounds */
            text-transform: uppercase;
        }

        /* Type-specific background colors */
        .types[data-type="Disease"] { background-color: #e74c3c; }
        .types[data-type="Condition"] { background-color: #f39c12; }
        .types[data-type="Anatomy"] { background-color: #27ae60; }
        .types[data-type="Previous Dental Work"] { background-color: #3498db; }
        .types[data-type="Unknown"] { background-color: #95a5a6; }

        /* Canvas Container */
        #resultContainer {
            position: relative;
            display: inline-block;
        }

        #resultContainer canvas {
            max-width: 100%;
            height: auto;
            border: 2px solid #3498db; 
            border-radius: 8px;
            position: relative;
        }

        /* Filter buttons */
        .filter-btn, .class-filter-btn {
            transition: all 0.3s ease;
            border-radius: 5px;
            padding: 8px 14px;
            background-color: white;
            color: #000;
        }

        .filter-btn.active, .class-filter-btn.active {
            background-color: #007bff !important;
            color: white;
        }

        /* Focus button */
        .focus-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .focus-btn:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        .detection-counter {
    margin-top: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #3498db;
}

.detection-counter h4 {
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 18px;
}

.counter-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
}

.counter-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.counter-class {
    font-weight: 600;
    color: #2c3e50;
}

.counter-count {
    background-color: #3498db;
    color: white;
    border-radius: 12px;
    padding: 2px 10px;
    font-size: 14px;
    font-weight: 600;
}

        /* Responsive */
        @media (max-width: 768px) {
            main {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tabs button {
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
        }
        
        nav a {
            margin: 0 12px;
            text-decoration: none;
            color: black;
            font-size: 14px;
        }
        
        nav a:hover {
            color: #4faeff;
            text-decoration: underline;
        }
        
        nav a.active {
            color: #4faeff;
        }
        
        /* Header */
        header.page-header {
            display: flex;
            justify-content: flex-start; 
            align-items: center;
            padding: 15px 30px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header.page-header h1 {
            margin-left: 60px; 
            margin-top: 0;
            margin-bottom: 0;
            font-size: 22px;
            color: black; 
            font-family: 'Poppins', sans-serif;
            font-weight: bold;
        }


        .content {
            margin-left: 60px;
            padding: 5px;
        }

        h2.upload-title {
            margin-top: 40px;
            margin-bottom: 5px;
            font-size: 27px;
            
        }

        #fileInput {
            margin: 15px 0 70px 0; 
        }

        h3.result-title {
            margin-bottom: 15px;
            color: #007bff; 
            font-weight: bold;
        }


    </style>
</head>
<body>
    <!-- Header -->
    <header class="page-header">
        <h1>TootHack</h1>
    </header>

    <!-- Sidebar -->
    <aside>
        {% include 'sidebar.html' %}
    </aside>

    <div class="content">
    <!-- Page Title -->
    <section>
        <h2>AI Analysis Results</h2>
        <p>Below is a summary of the detected issues from your AI analysis</p>
    </section>
    
    <h2 class="upload-title">Upload Dental X-ray</h2>
    <input type="file" id="fileInput">
    <h3 class="result-title">Result:</h3>
    <div style="margin: 10px 0;">
    <label for="drawMode">Display Mode: </label>
        <select id="drawMode">
            <option value="shapes">Draw Shapes (BBox + Mask, No Labels)</option>
            <option value="labels" selected>Draw Labels (BBox + Mask + Labels)</option>
            <option value="blacken">Blacken Mask</option>
            <option value="bbox">BBox Only</option>
            <option value="mask">Mask Only</option>
        </select>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="active" data-tab="overview">Overview</button>
        <button data-tab="recommendation">Recommendation</button>
    </div>

    <!-- Main Content: Overview -->
    <main id="overview" class="active">
        <!-- Left Cards - Will be populated by JavaScript -->
        <div id="detectionsContainer">
            <!-- Detection cards will be inserted here -->
            <div class="card">
                <h3>Analysis Results</h3>
                <p>Upload an X-ray to see detection results</p>
            </div>
        </div>

        <!-- Right Image -->

              <div class="card">
            <h3>Visual Feedback</h3>
            <div id="resultContainer">
                <img id="resultImg" style="max-width:100%; border:1px solid #ccc; display: none;">
                <!-- Canvas will be inserted here dynamically -->
            </div>
            
            <!-- Detection Counter -->
            <div id="detectionCounter" class="detection-counter" style="display: none;">
                <h4>Detection Summary</h4>
                <div id="counterItems">
                    <!-- Counter items will be inserted here -->
                </div>
            </div>
            
            <pre id="jsonOutput"></pre>

        </div>

    </main>

    <!-- Main Content: Recommendation -->
     <main id="recommendation">
            <div class="card">
                <div id="clinicsList" class="clinic-container">
                <p>Searching for nearby dental clinics...</p>
                </div>
            </div>
            <div class="card visual">
                <h3>Nearby Dental Clinics</h3>
                 <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBbaKFrbQ3WRCKxOyLD8hC28MZZyhMX4S4&libraries=places"></script>
                   <div id="map"></div>
        <style>
    #map { height: 100vh; width: 100%; }
    
   .clinic-container {
    max-height: 700px;  /* Adjust height as needed */
    overflow-y: auto;
      overflow-x: hidden;    
    padding-right: 5px;
    margin-top: 15px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .clinic-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 10px 15px;
    width: 100%;
    transition: transform 0.2s ease;
    cursor: pointer;
  }

  .clinic-card:hover {
    transform: scale(1.03);
    background: #f8faff;
  }

  .clinic-card h4 {
    margin: 0;
    color: #007bff;
  }

  .clinic-card p {
    margin: 3px 0;
    font-size: 14px;
    color: #444;
  }

  @media (max-width: 768px) {
    .clinic-card {
      width: 100%;
    }
  }
  </style>
        </div>
    </main>
    <script>
    let map;
  let infoWindow;

  function initMap() {
    const defaultLocation = { lat: 14.5995, lng: 120.9842 };

    map = new google.maps.Map(document.getElementById("map"), {
      center: defaultLocation,
      zoom: 14,
    });

    infoWindow = new google.maps.InfoWindow();

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        const userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude,
        };

        map.setCenter(userLocation);

        new google.maps.Marker({
          position: userLocation,
          map,
          title: "You are here",
          icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        });

        const service = new google.maps.places.PlacesService(map);
        service.nearbySearch(
          {
            location: userLocation,
            radius: 5000,
            type: "health",
            keyword: "dental",
          },
          (results, status) => {
            const clinicContainer = document.getElementById("clinicsList");
            clinicContainer.innerHTML = "";

            if (status === google.maps.places.PlacesServiceStatus.OK) {
              results.forEach(place => {
                createMarker(place);
                addClinicCard(place);
              });
            } else {
              clinicContainer.innerHTML = "<p>No clinics found nearby.</p>";
            }
          }
        );
      });
    }
  }

  function createMarker(place) {
    if (!place.geometry || !place.geometry.location) return;

    const marker = new google.maps.Marker({
      map,
      position: place.geometry.location,
      title: place.name,
    });

    google.maps.event.addListener(marker, "click", () => {
      const content = `
        <div>
          <h3>${place.name}</h3>
          <p><b>Address:</b> ${place.vicinity || "Not available"}</p>
          <p><b>Rating:</b> ${place.rating || "N/A"} ⭐</p>
        </div>
      `;
      infoWindow.setContent(content);
      infoWindow.open(map, marker);
    });
  }

  function addClinicCard(place) {
    const clinicContainer = document.getElementById("clinicsList");
    const card = document.createElement("div");
    card.className = "clinic-card";
    card.innerHTML = `
      <h4>${place.name}</h4>
      <p><b>Address:</b> ${place.vicinity || "Not available"}</p>
      <p><b>Rating:</b> ${place.rating || "N/A"} ⭐</p>
    `;

    card.addEventListener("click", () => {
      map.setCenter(place.geometry.location);
      map.setZoom(16);
    });

    clinicContainer.appendChild(card);
  }
    window.onload = initMap;
  </script>
    <!-- Footer Button -->
    <div class="footer-btn">
        <button>⬇ Download Report</button>
    </div>
</div>
    <script>
    const tabs = document.querySelectorAll(".tabs button");
    const sections = document.querySelectorAll("main");
    let currentDetections = [];
    let currentImageData = null;
    let currentDetectionData = [];
    let originalImageData = null;
    let activeFilter = null;
    let selectedDetections = new Set();
    let originalImage = null;
    let canvas = null;
    let ctx = null;
    let detectionOverlays = [];
    let drawMode = "labels";

    //detection counter
    function updateDetectionCounter(detections) {
        const counterContainer = document.getElementById('detectionCounter');
        const counterItems = document.getElementById('counterItems');
        
        if (!detections || detections.length === 0) {
            counterContainer.style.display = 'none';
            return;
        }
        
        const classCounts = {};
        detections.forEach(detection => {
            const className = detection.class;
            classCounts[className] = (classCounts[className] || 0) + 1;
        });
        
        const sortedClasses = Object.keys(classCounts).sort((a, b) => classCounts[b] - classCounts[a]);
        
        counterItems.innerHTML = '';
        
        sortedClasses.forEach(className => {
            const count = classCounts[className];
            const counterItem = document.createElement('div');
            counterItem.className = 'counter-item';
            counterItem.innerHTML = `
                <span class="counter-class">${className}</span>
                <span class="counter-count">${count}</span>
            `;
            counterItems.appendChild(counterItem);
        });
        
        counterContainer.style.display = 'block';
    }

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            tabs.forEach(t => t.classList.remove("active"));
            sections.forEach(s => s.classList.remove("active"));

            tab.classList.add("active");
            document.getElementById(tab.dataset.tab).classList.add("active");
        });
    });

    async function initializeCanvas() {
        if (!canvas) {
            canvas = document.createElement('canvas');
            canvas.style.display = 'block';
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            
            const resultContainer = document.getElementById('resultContainer');
            const resultImg = document.getElementById('resultImg');
            
            // Replace image with canvas
            resultImg.style.display = 'none';
            resultContainer.appendChild(canvas);
            
            ctx = canvas.getContext('2d');
        }
    }

    function drawImageWithFilter(selectedIds = null) {
        if (!originalImage || !canvas || !ctx) return;
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw original image
        ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
        
        detectionOverlays.forEach(overlay => {
            if (!selectedIds || selectedIds.includes(overlay.id)) {
                drawDetection(overlay);
            }
        });

    }
    document.getElementById("drawMode").addEventListener("change", (e) => {
    drawMode = e.target.value;

    // Redraw immediately with current filter/selection
    if (selectedDetections.size > 0) {
        filterImage(Array.from(selectedDetections));
    } else if (activeFilter) {
        const filteredDetections = currentDetections.filter(d => d.class === activeFilter);
        filterImage(filteredDetections.map(d => d.id));
    } else {
        filterImage(null); // redraw everything
    }
});
    function drawDetection(detection) {
    const { bbox, class: className, confidence, color, mask } = detection;

    const scaleX = canvas.width / originalImage.width;
    const scaleY = canvas.height / originalImage.height;

    const [x1, y1, x2, y2] = [
        bbox[0] * scaleX,
        bbox[1] * scaleY,
        bbox[2] * scaleX,
        bbox[3] * scaleY
    ];

    let bboxColor = '#ff0000';
    let rgbColor = [255, 0, 0];
    if (Array.isArray(color)) {
        bboxColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
        rgbColor = color;
    }

    // Handle mask drawing first
    if (mask && (drawMode !== "bbox")) {   // skip mask if mode is BBox only
        const maskImg = new Image();
        maskImg.onload = function() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = maskImg.width;
            tempCanvas.height = maskImg.height;
            tempCtx.drawImage(maskImg, 0, 0);

            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 0) {
                    if (drawMode === "blacken") {
                        data[i]   = 0;   // R
                        data[i+1] = 0;   // G
                        data[i+2] = 0;   // B
                        data[i+3] = 255; // Alpha (0 = transparent, 255 = fully opaque)
                    } else {
                        data[i] = rgbColor[0];
                        data[i+1] = rgbColor[1];
                        data[i+2] = rgbColor[2];
                    }
                }
            }

            tempCtx.putImageData(imageData, 0, 0);

            // For blacken, draw solid (no opacity)
            if (drawMode === "blacken") {
                ctx.globalAlpha = 1.0;
            } else {
                ctx.globalAlpha = 0.9; // semi-transparent for colored masks
            }

            ctx.drawImage(
                tempCanvas,
                bbox[0], bbox[1], bbox[2] - bbox[0], bbox[3] - bbox[1],
                x1, y1, x2 - x1, y2 - y1
            );

            ctx.globalAlpha = 1.0;

            // Draw BBox if NOT in mask-only mode
            if (drawMode !== "blacken" && drawMode !== "mask") {
                ctx.strokeStyle = bboxColor;
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, x2-x1, y2-y1);
            }

            // Draw label only if mode = labels
            if (drawMode === "labels") {
                ctx.fillStyle = bboxColor.replace(')', ', 0.7)').replace('rgb', 'rgba');
                ctx.fillRect(x1, y1 - 20, 150, 20);

                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(`${className}: ${(confidence * 100).toFixed(1)}%`, x1+5, y1-5);
            }
        };
        maskImg.src = "data:image/png;base64," + mask;
    } else {
        // if NO mask available or BBox-only mode
        if (drawMode !== "mask") {
            ctx.strokeStyle = bboxColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(x1, y1, x2-x1, y2-y1);

            if (drawMode === "labels") {
                ctx.fillStyle = bboxColor.replace(')', ', 0.7)').replace('rgb', 'rgba');
                ctx.fillRect(x1, y1 - 20, 150, 20);

                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(`${className}: ${(confidence * 100).toFixed(1)}%`, x1+5, y1-5);
            }
        }
    }
}


    function prepareDetectionOverlays(detectionData) {
        return detectionData.map((detection) => {
            return {
                id: detection.id,
                class: detection.class,
                confidence: detection.confidence,
                bbox: detection.bbox,
                color: detection.color,
                mask: detection.mask || null
            };
        });
    }

    // Client-side filtering function
    function filterImage(selectedIds) {
        drawImageWithFilter(selectedIds);
    }

    document.getElementById("fileInput").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append("image", file);

        try {
            const response = await fetch("/predict", {
                method: "POST",
                body: formData
            });

            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            currentDetections = result.detections;
            currentImageData = result.annotated_image;
            currentDetectionData = result.detection_data || [];
            originalImageData = result.original_image;
            
            await initializeCanvas();
            
            // Load original image
            originalImage = new Image();
            originalImage.onload = function() {
                canvas.width = originalImage.width;
                canvas.height = originalImage.height;
                
                // Prepare detection overlays
                detectionOverlays = prepareDetectionOverlays(currentDetectionData);
                
                // Draw image with all detections
                drawImageWithFilter();
            };
            originalImage.src = "data:image/jpeg;base64," + originalImageData;
            
            // Update the detection cards
            updateDetectionCards(currentDetections);
            
            // Update detection counter
            updateDetectionCounter(currentDetections);
            
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while processing the image: " + error.message);
        }
    });

    function updateDetectionCards(detections) {
        const container = document.getElementById("detectionsContainer");
        container.innerHTML = "";
        
        if (!detections || detections.length === 0) {
            container.innerHTML = `
                <div class="card">
                    <h3>No Issues Detected</h3>
                    <p>No dental issues were detected in this X-ray.</p>
                </div>
            `;
            return;
        }
        
         //filter controls
        const filterControls = document.createElement("div");
        filterControls.style.marginBottom = "15px";
        filterControls.innerHTML = `
            <button id="showAllBtn" class="filter-btn active" style="margin-right: 10px; padding: 8px 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Show All
            </button>
            <span style="font-weight: bold;">Filter by class:</span>
        `;
        container.appendChild(filterControls);
        
        //click event to Show All button
        document.getElementById("showAllBtn").addEventListener("click", () => {
            document.querySelectorAll(".class-filter-btn").forEach(btn => {
                btn.classList.remove("active");
            });
            document.getElementById("showAllBtn").classList.add("active");
            
            activeFilter = null;
            selectedDetections.clear();
            renderDetectionCards(currentDetections);
            
            // Show all detections on canvas
            filterImage(null);
            
        });
        
        // Create a card for each detection
        renderDetectionCards(detections);
        
        //class filter buttons
        const uniqueClasses = [...new Set(detections.map(d => d.class))];
        uniqueClasses.forEach(className => {
            const filterBtn = document.createElement("button");
            filterBtn.textContent = className;
            filterBtn.className = "class-filter-btn";
            filterBtn.style.margin = "5px";
            filterBtn.style.padding = "5px 10px";
            filterBtn.style.backgroundColor = "#ecf0f1";
            filterBtn.style.border = "none";
            filterBtn.style.borderRadius = "4px";
            filterBtn.style.cursor = "pointer";

            // Set default background color
            filterBtn.style.backgroundColor = getDiseaseColor(className);
            filterBtn.style.color = (getDiseaseColor(className) === "#ecf0f1") ? "black" : "white";

            
            filterBtn.addEventListener("click", () => {
                document.querySelectorAll(".class-filter-btn").forEach(btn => {
                    btn.classList.remove("active");
                });
                document.getElementById("showAllBtn").classList.remove("active");
                filterBtn.classList.add("active");
                
                activeFilter = className;
                const filteredDetections = currentDetections.filter(d => d.class === className);
                selectedDetections.clear();
                renderDetectionCards(filteredDetections);
                
                // Filter image to show only this class
                const classIds = filteredDetections.map(d => d.id);
                filterImage(classIds);
                
            });
            
            filterControls.appendChild(filterBtn);
        });
    }


     // Helper function to get color based on disease
        function getDiseaseColor(className) {
            switch(className.toLowerCase()) {
                case "filling": return "#921c56"; // pink
                case "caries": return "#66ac5d"; // green
                case "root piece": return "#c28b37"; // orange
                case "impacted tooth": return "#81bfbb"; // teal
                case "root canal treatment": return "#360457"; // violet
                case "missing teeth": return "#584c4f"; // brown
                 case "periapical lesion": return "#938092"; // pinkidark
                case "crown": return "#185840"; // green
                default: return "#ecf0f1"; // gray for unknown
            }
        }


    function renderDetectionCards(detections) {
        const container = document.getElementById("detectionsContainer");
        
        // Remove existing cards (but keep filter controls)
        const filterControls = container.querySelector("div");
        const existingCards = container.querySelectorAll(".detection-card");
        existingCards.forEach(card => card.remove());
        
        if (!detections || detections.length === 0) {
            const noResults = document.createElement("div");
            noResults.className = "card";
            noResults.innerHTML = `
                <h3>No Matching Issues</h3>
                <p>No dental issues match the current filter.</p>
            `;
            container.appendChild(noResults);
            return;
        }
        
        //card creation
        detections.forEach((detection) => {
            const card = document.createElement("div");
            card.className = "detection-card";
            card.style.cursor = "pointer";
            card.style.transition = "all 0.3s ease";
            card.dataset.detectionId = detection.id;


            card.innerHTML = `
                <h4>${detection.class}</h4>
                <p><span class="types" data-type="${detection.types}">${detection.types}</span></p>
                <p>ID: ${detection.id}</p>
                <p>Description: ${detection.description}</p>
                <p>Confidence: <span class="confidence">${(detection.confidence * 100).toFixed(1)}%</span></p>
                <button class="focus-btn" style="margin-top: 10px; padding: 5px 10px; font-size: 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                </button>
            `;
            
            //click event
            card.addEventListener("click", () => {
                const cardId = detection.id;

                if (selectedDetections.has(cardId)) {
                    // Deselect this card
                    selectedDetections.delete(cardId);
                    card.style.border = 'none';
                    card.style.backgroundColor = '';
                } else {
                    // Select this card
                    selectedDetections.add(cardId);
                    card.style.border = '2px solid #3498db';
                    card.style.backgroundColor = '#f0f8ff';
                }

                if (selectedDetections.size > 0) {
                    // Show only selected cards
                    filterImage(Array.from(selectedDetections));
                } else {
                    if (activeFilter) {
                        const filteredDetections = currentDetections.filter(d => d.class === activeFilter);
                        renderDetectionCards(filteredDetections);
                        filterImage(filteredDetections.map(d => d.id));
                    } else {
                        filterImage(null);
                    }
                }
            });
            
            //hover effect
            card.addEventListener("mouseenter", () => {
                card.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
                card.style.transform = "translateY(-2px)";
            });
            
            card.addEventListener("mouseleave", () => {
                if (card.style.border !== '2px solid #3498db') {
                    card.style.boxShadow = "0 2px 4px rgba(0, 0, 0, 0.1)";
                }
                card.style.transform = "translateY(0)";
            });
            
            container.appendChild(card);
        });
    }

    function updateRecommendations(detections) {
        const container = document.getElementById("recommendationsList");
        container.innerHTML = "";
        
        if (!detections || detections.length === 0) {
            container.innerHTML = `
                <p>No specific recommendations needed. Maintain good oral hygiene and regular checkups.</p>
            `;
            return;
        }
        
        const ul = document.createElement("ul");
        
        detections.forEach(detection => {
            const li = document.createElement("li");
            
            // Custom recommendations based on detection class
            const className = detection.class.toLowerCase();
            
            if (className.includes("caries") || className.includes("decay")) {
                li.textContent = `For ${detection.class}: Dental filling is recommended to prevent further decay.`;
            } else if (className.includes("crack") || className.includes("fracture")) {
                li.textContent = `For ${detection.class}: Dental crown may be needed to protect the tooth.`;
            } else if (className.includes("infection") || className.includes("lesion")) {
                li.textContent = `For ${detection.class}: Root canal treatment may be necessary.`;
            } else if (className.includes("missing")) {
                li.textContent = `For ${detection.class}: Consider dental implants or bridges.`;
            } else {
                li.textContent = `For ${detection.class}: Further examination by a dentist is recommended.`;
            }
            
            ul.appendChild(li);
        });
        
        const generalLi = document.createElement("li");
        generalLi.textContent = "Maintain improved oral hygiene practices and schedule regular dental visits.";
        ul.appendChild(generalLi);
        
        container.appendChild(ul);
    }
</script>
</body>
</html>