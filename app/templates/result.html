<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental X-ray Analysis</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', 'Roboto', sans-serif;
        }
        
        body {
            margin: 0;
            padding: 0;
            color: black;
            background: #fff;
            margin-left:4%;
            font-family: 'Roboto', sans-serif;
        }

         h1, h2, h3, h4 {
          font-family: 'Poppins', sans-serif;
          color: #007bff; 
      }

        p, li {
          font-family: 'Roboto', sans-serif;
          color: #007bff; 
      }
        
        section {
            margin: 40px 0;
        }
        
        h2 {
            color: black;
            margin-bottom: 10px;
            font-size: 35px;
        }

        h3{
            font-size: 30px;
        }
        
        p {
            color: black;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        input[type="file"] {
            margin: 15px 0;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            width: 100%;
            background-color: #ecf0f1;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin: 20px 0;
            border-bottom: 2px solid #ddd;
        }
        
        .tabs button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: black;
            transition: all 0.3s;
        }
        
        .tabs button.active {
            color: black;
            border-bottom: 3px solid #007bff;
        }
        
        .tabs button:hover {
            background-color: #007bff; 
            color: white; 
            border-radius: 5px; 
        }

        
        /* Main Content */
        main {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        main.active {
            display: grid;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            position: relative;
            border-left: 5px solid #3498db; 
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.2); 
            transform: translateY(-3px);
        }

        .card h3 {
            color: #007bff; 
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #3498db; 
            padding-bottom: 10px;
        }

        .card p {
            color: #34495e;
            margin-bottom: 15px;
        }

        .card ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }

        .card li {
            margin-bottom: 10px;
            color: #000; 
        }

        /* Badges */
        .badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #3498db; 
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Buttons */
        button {
            padding: 10px 15px;
            background-color: #3498db; 
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        button:hover {
            background-color: #2980b9; 
            transform: scale(1.05); 
        }

        
        #retakeBtn {
            background-color: #7f8c8d;
            width: 100%;
            margin-top: 15px;
        }
        
        #retakeBtn:hover {
            background-color: #95a5a6;
        }
        
        /* Image */
        img {
            max-width: 100%;
            border-radius: 5px;
            display: block;
        }
        
        /* JSON Output */
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin-top: 15px;
            font-size: 14px;
            border-left: 4px solid #3498db;
            color: #2c3e50;
            display: none;
        }

        /* Footer Button */
        .footer-btn {
            margin-top: 30px;
            text-align: center;
        }

        .footer-btn button {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #3498db; 
            border-radius: 8px;
            border: none;
            color: white;
            transition: background-color 0.3s, transform 0.2s;
        }

        .footer-btn button:hover {
            background-color: #2980b9; 
            transform: scale(1.05);
        }

        /* Detection cards */
        .detection-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
            padding: 18px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db; 
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .detection-card:hover {
            box-shadow: 0 6px 12px rgba(0, 123, 255, 0.2);
            transform: translateY(-3px);
        }

        .detection-card h4 {
            color: #007bff;
            margin-bottom: 10px;
        }

        .detection-card p {
            margin-bottom: 8px;
            color: #000; 
        }

        .confidence {
            display: inline-block;
            padding: 4px 10px;
            background-color: #ecf6ff; 
            border-radius: 12px;
            font-size: 12px;
            color: #007bff;
            font-weight: 500;
        }

        /* Canvas Container */
        #resultContainer {
            position: relative;
            display: inline-block;
        }

        #resultContainer canvas {
            max-width: 100%;
            height: auto;
            border: 2px solid #3498db; 
            border-radius: 8px;
            position: relative;
        }

        /* Filter buttons */
        .filter-btn, .class-filter-btn {
            transition: all 0.3s ease;
            border-radius: 5px;
            padding: 8px 14px;
            background-color: white;
            color: #000;
        }

        .filter-btn.active, .class-filter-btn.active {
            background-color: #007bff !important;
            color: white;
        }

        /* Focus button */
        .focus-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }

        .focus-btn:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        
        /* Responsive */
        @media (max-width: 768px) {
            main {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tabs button {
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
        }
        
        nav a {
            margin: 0 12px;
            text-decoration: none;
            color: black;
            font-size: 14px;
        }
        
        nav a:hover {
            color: #4faeff;
            text-decoration: underline;
        }
        
        nav a.active {
            color: #4faeff;
        }
        
        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        header h1 {
            margin: 0;
            font-size: 22px;
        }




    </style>
</head>
<body>
    <!-- Header -->
    <aside >
        <div class="header-left">
            <h1>TootHack</h1>
        </div>
        {% include 'sidebar.html' %}
    </aside>
    <!-- Page Title -->
    <section>
        <h2>AI Analysis Results</h2>
        <p>Below is a summary of the detected issues from your AI analysis</p>
    </section>
    
    <h2>Upload Dental X-ray</h2>
    <input type="file" id="fileInput">
    <h3>Result:</h3>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="active" data-tab="overview">Overview</button>
        <button data-tab="recommendation">Recommendation</button>
    </div>

    <!-- Main Content: Overview -->
    <main id="overview" class="active">
        <!-- Left Cards - Will be populated by JavaScript -->
        <div id="detectionsContainer">
            <!-- Detection cards will be inserted here -->
            <div class="card">
                <h3>Analysis Results</h3>
                <p>Upload an X-ray to see detection results</p>
            </div>
        </div>

        <!-- Right Image -->
       <div class="card">
        <h3>Visual Feedback</h3>
        <div id="resultContainer">
            <!-- Loader overlay -->
            <div id="loadingSpinner" class="loading-overlay" style="display: none;">
                <div class="loader"></div>
                <p>Processing image...</p>
            </div>

            <img id="resultImg" style="max-width:100%; border:1px solid #ccc; display:none;">
            <!-- Canvas will be inserted here dynamically -->
        </div>
        <pre id="jsonOutput"></pre>
</div>

    </main>

    <!-- Main Content: Recommendation -->
    <main id="recommendation">
        <div class="card">
            <h3>Recommendations:</h3>
            <div id="recommendationsList">
                <p>Upload an X-ray to get personalized recommendations</p>
            </div>
            <img src="{{ url_for('static', filename='images/map.jpg') }}" alt="Map" style="width:100%; border-radius:10px; margin-top:10px; display: none;">
        </div>
    </main>

    <!-- Footer Button -->
    <div class="footer-btn">
        <button>⬇ Download Report</button>
    </div>

    <script>
        const tabs = document.querySelectorAll(".tabs button");
        const sections = document.querySelectorAll("main");
        let currentDetections = [];
        let currentImageData = null;
        let currentDetectionData = [];
        let originalImageData = null;
        let activeFilter = null;
        
        // Canvas variables
        let originalImage = null;
        let canvas = null;
        let ctx = null;
        let detectionOverlays = [];

        tabs.forEach(tab => {
            tab.addEventListener("click", () => {
                tabs.forEach(t => t.classList.remove("active"));
                sections.forEach(s => s.classList.remove("active"));

                tab.classList.add("active");
                document.getElementById(tab.dataset.tab).classList.add("active");
            });
        });

        async function initializeCanvas() {
            // Create canvas if it doesn't exist
            if (!canvas) {
                canvas = document.createElement('canvas');
                canvas.style.display = 'block';
                canvas.style.maxWidth = '100%';
                canvas.style.height = 'auto';
                
                const resultContainer = document.getElementById('resultContainer');
                const resultImg = document.getElementById('resultImg');
                
                // Replace image with canvas
                resultImg.style.display = 'none';
                resultContainer.appendChild(canvas);
                
                ctx = canvas.getContext('2d');
            }
        }

        function drawImageWithFilter(selectedIds = null) {
            if (!originalImage || !canvas || !ctx) return;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw original image
            ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
            
            // Draw only selected detections (or all if null)
            detectionOverlays.forEach(overlay => {
                if (!selectedIds || selectedIds.includes(overlay.id)) {
                    drawDetection(overlay);
                }
            });
        }

        function drawDetection(detection, onComplete) {
    const { bbox, class: className, confidence, color, mask } = detection;
    
    // Scale factors
    const scaleX = canvas.width / originalImage.width;
    const scaleY = canvas.height / originalImage.height;

    const [x1, y1, x2, y2] = [
        bbox[0] * scaleX,
        bbox[1] * scaleY,
        bbox[2] * scaleX,
        bbox[3] * scaleY
    ];

    let bboxColor = '#ff0000'; // default
    let rgbColor = [255, 0, 0]; // default RGB values
    
    if (Array.isArray(color)) {
        bboxColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
        rgbColor = color;
    } else if (typeof color === 'string') {
        bboxColor = color;
        if (color.startsWith('#')) {
            const hex = color.replace('#', '');
            rgbColor = [
                parseInt(hex.substring(0, 2), 16),
                parseInt(hex.substring(2, 4), 16),
                parseInt(hex.substring(4, 6), 16)
            ];
        }
    }

    if (mask) {
        const maskImg = new Image();
        maskImg.onload = function() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = maskImg.width;
            tempCanvas.height = maskImg.height;
            
            tempCtx.drawImage(maskImg, 0, 0);
            
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                if (data[i + 3] > 0) {
                    data[i] = rgbColor[0];
                    data[i + 1] = rgbColor[1];
                    data[i + 2] = rgbColor[2];
                }
            }
            
            tempCtx.putImageData(imageData, 0, 0);
            ctx.globalAlpha = 0.8;
            ctx.drawImage(
                tempCanvas, 
                bbox[0], bbox[1], bbox[2] - bbox[0], bbox[3] - bbox[1],
                x1, y1, x2 - x1, y2 - y1
            );
            ctx.globalAlpha = 1.0;

            // Draw bounding box + label
            ctx.strokeStyle = bboxColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
            ctx.fillStyle = bboxColor.replace(')', ', 0.7)').replace('rgb', 'rgba');
            ctx.fillRect(x1, y1 - 20, 150, 20);
            ctx.fillStyle = 'white';
            ctx.font = '14px Arial';
            ctx.fillText(`${className}: ${(confidence * 100).toFixed(1)}%`, x1 + 5, y1 - 5);

        };
        maskImg.src = "data:image/png;base64," + mask;
    } else {
        // Fallback if no mask
        ctx.strokeStyle = bboxColor;
        ctx.lineWidth = 2;
        ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

        ctx.fillStyle = bboxColor.replace(')', ', 0.7)').replace('rgb', 'rgba');
        ctx.fillRect(x1, y1 - 20, 150, 20);

        ctx.fillStyle = 'white';
        ctx.font = '14px Arial';
        ctx.fillText(`${className}: ${(confidence * 100).toFixed(1)}%`, x1 + 5, y1 - 5);

       
    }
}



function prepareDetectionOverlays(detectionData) {
    return detectionData.map((detection) => {
        // Keep the original color array
        return {
            id: detection.id,
            class: detection.class,
            confidence: detection.confidence,
            bbox: detection.bbox,
            color: detection.color, // Keep as array [R, G, B]
            mask: detection.mask || null
        };
    });
}

        // Client-side filtering function
        function filterImage(selectedIds) {
            drawImageWithFilter(selectedIds);
        }

        document.getElementById("fileInput").addEventListener("change", async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append("image", file);

            try {
                const response = await fetch("/predict", {
                    method: "POST",
                    body: formData
                });

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error);
                }
                
                // Store the data globally
                currentDetections = result.detections;
                currentImageData = result.annotated_image;
                currentDetectionData = result.detection_data || [];
                originalImageData = result.original_image;
                
                // Initialize canvas
                await initializeCanvas();
                
                // Load original image
                originalImage = new Image();
                originalImage.onload = function() {
                    // Set canvas size to match image
                    canvas.width = originalImage.width;
                    canvas.height = originalImage.height;
                    
                    // Prepare detection overlays
                    detectionOverlays = prepareDetectionOverlays(currentDetectionData);
                    
                    // Draw image with all detections
                    drawImageWithFilter();
                };
                originalImage.src = "data:image/jpeg;base64," + originalImageData;
                
                // Update the detection cards
                updateDetectionCards(currentDetections);
                
                // Update recommendations
                updateRecommendations(currentDetections);
                
            } catch (error) {
                console.error("Error:", error);
                alert("An error occurred while processing the image: " + error.message);
            }
        });

        function updateDetectionCards(detections) {
            const container = document.getElementById("detectionsContainer");
            container.innerHTML = "";
            
            if (!detections || detections.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <h3>No Issues Detected</h3>
                        <p>No dental issues were detected in this X-ray.</p>
                    </div>
                `;
                return;
            }
            
            // Add filter controls
            const filterControls = document.createElement("div");
            filterControls.style.marginBottom = "15px";
            filterControls.innerHTML = `
                <button id="showAllBtn" class="filter-btn active" style="margin-right: 10px; padding: 8px 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Show All
                </button>
                <span style="font-weight: bold;">Filter by class:</span>
            `;
            container.appendChild(filterControls);
            
            // Add click event to Show All button
            document.getElementById("showAllBtn").addEventListener("click", () => {
                document.querySelectorAll(".class-filter-btn").forEach(btn => {
                    btn.classList.remove("active");
                });
                document.getElementById("showAllBtn").classList.add("active");
                
                activeFilter = null;
                renderDetectionCards(currentDetections);
                
                // Show all detections on canvas
                filterImage(null);
            });
            
            // Create a card for each detection
            renderDetectionCards(detections);
            
            // Add class filter buttons
            const uniqueClasses = [...new Set(detections.map(d => d.class))];
            uniqueClasses.forEach(className => {
                const filterBtn = document.createElement("button");
                filterBtn.textContent = className;
                filterBtn.className = "class-filter-btn";
                filterBtn.style.margin = "5px";
                filterBtn.style.padding = "5px 10px";
                filterBtn.style.backgroundColor = "#ecf0f1";
                filterBtn.style.border = "none";
                filterBtn.style.borderRadius = "4px";
                filterBtn.style.cursor = "pointer";
                
                filterBtn.addEventListener("click", () => {
                    document.querySelectorAll(".class-filter-btn").forEach(btn => {
                        btn.classList.remove("active");
                    });
                    document.getElementById("showAllBtn").classList.remove("active");
                    filterBtn.classList.add("active");
                    
                    activeFilter = className;
                    const filteredDetections = currentDetections.filter(d => d.class === className);
                    renderDetectionCards(filteredDetections);
                    
                    // Filter image to show only this class
                    const classIds = filteredDetections.map(d => d.id);
                    filterImage(classIds);
                });
                
                filterControls.appendChild(filterBtn);
            });
        }

        function renderDetectionCards(detections) {
            const container = document.getElementById("detectionsContainer");
            
            // Remove existing cards (but keep filter controls)
            const filterControls = container.querySelector("div");
            const existingCards = container.querySelectorAll(".detection-card");
            existingCards.forEach(card => card.remove());
            
            if (!detections || detections.length === 0) {
                const noResults = document.createElement("div");
                noResults.className = "card";
                noResults.innerHTML = `
                    <h3>No Matching Issues</h3>
                    <p>No dental issues match the current filter.</p>
                `;
                container.appendChild(noResults);
                return;
            }
            
            // Create a card for each detection
            detections.forEach((detection) => {
                const card = document.createElement("div");
                card.className = "detection-card";
                card.style.cursor = "pointer";
                card.style.transition = "all 0.3s ease";
                card.dataset.detectionId = detection.id;
                
                card.innerHTML = `
                    <h4>${detection.class}</h4>
                    <p>ID: ${detection.id}</p>
                    <p>Confidence: <span class="confidence">${(detection.confidence * 100).toFixed(1)}%</span></p>
                    <button class="focus-btn" style="margin-top: 10px; padding: 5px 10px; font-size: 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                    </button>
                `;
                
                // Add click event to focus on this specific detection
                const focusBtn = card.querySelector(".focus-btn");
                focusBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    
                    const filteredDetections = currentDetections.filter(d => d.id === detection.id);
                    renderDetectionCards(filteredDetections);
                    
                    document.querySelectorAll(".class-filter-btn").forEach(btn => {
                        btn.classList.remove("active");
                    });
                    document.getElementById("showAllBtn").classList.remove("active");
                    
                    // Filter image to show only this detection
                    filterImage([detection.id]);
                });
                
                // Add click event to the entire card
                card.addEventListener("click", () => {
                    document.querySelectorAll('.detection-card').forEach(c => {
                        c.style.border = 'none';
                        c.style.backgroundColor = '';
                    });
                    
                    if (card.style.border !== '2px solid #3498db') {
                        card.style.border = '2px solid #3498db';
                        card.style.backgroundColor = '#f0f8ff';
                        filterImage([detection.id]);
                    } else {
                        card.style.border = 'none';
                        card.style.backgroundColor = '';
                        filterImage(null); // Show all detections
                    }
                });
                
                // Add hover effect
                card.addEventListener("mouseenter", () => {
                    card.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
                    card.style.transform = "translateY(-2px)";
                });
                
                card.addEventListener("mouseleave", () => {
                    if (card.style.border !== '2px solid #3498db') {
                        card.style.boxShadow = "0 2px 4px rgba(0, 0, 0, 0.1)";
                    }
                    card.style.transform = "translateY(0)";
                });
                
                container.appendChild(card);
            });
        }

        function updateRecommendations(detections) {
            const container = document.getElementById("recommendationsList");
            container.innerHTML = "";
            
            if (!detections || detections.length === 0) {
                container.innerHTML = `
                    <p>No specific recommendations needed. Maintain good oral hygiene and regular checkups.</p>
                `;
                return;
            }
            
            const ul = document.createElement("ul");
            
            detections.forEach(detection => {
                const li = document.createElement("li");
                
                // Custom recommendations based on detection class
                const className = detection.class.toLowerCase();
                
                if (className.includes("caries") || className.includes("decay")) {
                    li.textContent = `For ${detection.class}: Dental filling is recommended to prevent further decay.`;
                } else if (className.includes("crack") || className.includes("fracture")) {
                    li.textContent = `For ${detection.class}: Dental crown may be needed to protect the tooth.`;
                } else if (className.includes("infection") || className.includes("lesion")) {
                    li.textContent = `For ${detection.class}: Root canal treatment may be necessary.`;
                } else if (className.includes("missing")) {
                    li.textContent = `For ${detection.class}: Consider dental implants or bridges.`;
                } else {
                    li.textContent = `For ${detection.class}: Further examination by a dentist is recommended.`;
                }
                
                ul.appendChild(li);
            });
            
            const generalLi = document.createElement("li");
            generalLi.textContent = "Maintain improved oral hygiene practices and schedule regular dental visits.";
            ul.appendChild(generalLi);
            
            container.appendChild(ul);
        }

    </script>
</body>
</html>