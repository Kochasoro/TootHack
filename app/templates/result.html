<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental X-ray Analysis</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #222;
            background: #fff;
            margin-left:4%;
        }
        
        section {
            margin-bottom: 30px;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        p {
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        
        input[type="file"] {
            margin: 15px 0;
            padding: 10px;
            border: 2px dashed #3498db;
            border-radius: 5px;
            width: 100%;
            background-color: #ecf0f1;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            margin: 20px 0;
            border-bottom: 2px solid #ddd;
        }
        
        .tabs button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s;
        }
        
        .tabs button.active {
            color: #2980b9;
            border-bottom: 3px solid #2980b9;
        }
        
        .tabs button:hover {
            color: #2980b9;
        }
        
        /* Main Content */
        main {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        main.active {
            display: grid;
        }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            position: relative;
        }
        
        .card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        
        .card p {
            color: #34495e;
            margin-bottom: 15px;
        }
        
        .card ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .card li {
            margin-bottom: 10px;
            color: #34495e;
        }
        
        /* Badges */
        .badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Buttons */
        button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        #retakeBtn {
            background-color: #7f8c8d;
            width: 100%;
            margin-top: 15px;
        }
        
        #retakeBtn:hover {
            background-color: #95a5a6;
        }
        
        /* Image */
        img {
            max-width: 100%;
            border-radius: 5px;
            display: block;
        }
        
        /* JSON Output */
        pre {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }
        
        /* Footer Button */
        .footer-btn {
            margin-top: 30px;
            text-align: center;
        }
        
        .footer-btn button {
            padding: 12px 24px;
            font-size: 16px;
            background-color: #2c3e50;
        }
        
        .footer-btn button:hover {
            background-color: #34495e;
        }
        #detectionsContainer {
            max-height: 700px; /* Adjust this value as needed */
            overflow-y: auto;
            padding-right: 10px; /* Add some padding so scrollbar doesn't overlap content */
        }

        /* Custom scrollbar styling */
        #detectionsContainer::-webkit-scrollbar {
            width: 8px;
        }

        #detectionsContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #detectionsContainer::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        #detectionsContainer::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* For Firefox */
        #detectionsContainer {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        /* Detection cards */
        .detection-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .detection-card h4 {
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .detection-card p {
            margin-bottom: 8px;
            color: #34495e;
        }
        
        .confidence {
            display: inline-block;
            padding: 3px 8px;
            background-color: #ecf0f1;
            border-radius: 12px;
            font-size: 12px;
            color: #7f8c8d;
        }
        .types {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white; /* Better contrast with colored backgrounds */
            text-transform: uppercase;
        }

        /* Type-specific background colors */
        .types[data-type="Disease"] { background-color: #e74c3c; }
        .types[data-type="Condition"] { background-color: #f39c12; }
        .types[data-type="Anatomy"] { background-color: #27ae60; }
        .types[data-type="Previous Dental Work"] { background-color: #3498db; }
        .types[data-type="Unknown"] { background-color: #95a5a6; }
        /* Canvas Container */
        #resultContainer {
            position: relative;
            display: inline-block;
        }
        
        #resultContainer canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        /* Filter buttons */
        .filter-btn, .class-filter-btn {
            transition: all 0.3s ease;
        }
        
        .filter-btn.active, .class-filter-btn.active {
            background-color: #2c3e50 !important;
            color: white;
        }
        
        .detection-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .detection-card:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            transform: translateY(-2px);
        }
        
        .focus-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .focus-btn:hover {
            background-color: #2980b9;
        }
        .detection-counter {
    margin-top: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #3498db;
}

.detection-counter h4 {
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 18px;
}

.counter-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    padding-bottom: 8px;
    border-bottom: 1px solid #eee;
}

.counter-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
    padding-bottom: 0;
}

.counter-class {
    font-weight: 600;
    color: #2c3e50;
}

.counter-count {
    background-color: #3498db;
    color: white;
    border-radius: 12px;
    padding: 2px 10px;
    font-size: 14px;
    font-weight: 600;
}
        /* Responsive */
        @media (max-width: 768px) {
            main {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tabs button {
                text-align: left;
                border-bottom: 1px solid #ddd;
            }
        }
        
        nav a {
            margin: 0 12px;
            text-decoration: none;
            color: black;
            font-size: 14px;
        }
        
        nav a:hover {
            color: #4faeff;
            text-decoration: underline;
        }
        
        nav a.active {
            color: #4faeff;
        }
        
        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        header h1 {
            margin: 0;
            font-size: 22px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <aside >
        <div class="header-left">
            <h1>TootHack</h1>
        </div>
        {% include 'sidebar.html' %}
    </aside>
    <!-- Page Title -->
    <section>
        <h2>AI Analysis Results</h2>
        <p>Below is a summary of the detected issues from your AI analysis</p>
    </section>
    
    <h2>Upload Dental X-ray</h2>
    <input type="file" id="fileInput">
    <h3>Result:</h3>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="active" data-tab="overview">Overview</button>
        <button data-tab="recommendation">Recommendation</button>
    </div>

    <!-- Main Content: Overview -->
    <main id="overview" class="active">
        <!-- Left Cards - Will be populated by JavaScript -->
        <div id="detectionsContainer">
            <!-- Detection cards will be inserted here -->
            <div class="card">
                <h3>Analysis Results</h3>
                <p>Upload an X-ray to see detection results</p>
            </div>
        </div>

        <!-- Right Image -->
              <div class="card">
            <h3>Visual Feedback</h3>
            <div id="resultContainer">
                <img id="resultImg" style="max-width:100%; border:1px solid #ccc; display: none;">
                <!-- Canvas will be inserted here dynamically -->
            </div>
            
            <!-- Detection Counter -->
            <div id="detectionCounter" class="detection-counter" style="display: none;">
                <h4>Detection Summary</h4>
                <div id="counterItems">
                    <!-- Counter items will be inserted here -->
                </div>
            </div>
            
            <pre id="jsonOutput"></pre>
        </div>
    </main>

    <!-- Main Content: Recommendation -->
    <main id="recommendation">
        <div class="card">
            <h3>Recommendations:</h3>
            <div id="recommendationsList">
                <p>Upload an X-ray to get personalized recommendations</p>
            </div>
            <img src="{{ url_for('static', filename='images/map.jpg') }}" alt="Map" style="width:100%; border-radius:10px; margin-top:10px; display: none;">
        </div>
    </main>

    <!-- Footer Button -->
    <div class="footer-btn">
        <button>⬇ Download Report</button>
    </div>

    <script>
    const tabs = document.querySelectorAll(".tabs button");
    const sections = document.querySelectorAll("main");
    let currentDetections = [];
    let currentImageData = null;
    let currentDetectionData = [];
    let originalImageData = null;
    let activeFilter = null;
    let selectedDetections = new Set();
    let originalImage = null;
    let canvas = null;
    let ctx = null;
    let detectionOverlays = [];

    //detection counter
    function updateDetectionCounter(detections) {
        const counterContainer = document.getElementById('detectionCounter');
        const counterItems = document.getElementById('counterItems');
        
        if (!detections || detections.length === 0) {
            counterContainer.style.display = 'none';
            return;
        }
        
        const classCounts = {};
        detections.forEach(detection => {
            const className = detection.class;
            classCounts[className] = (classCounts[className] || 0) + 1;
        });
        
        const sortedClasses = Object.keys(classCounts).sort((a, b) => classCounts[b] - classCounts[a]);
        
        counterItems.innerHTML = '';
        
        sortedClasses.forEach(className => {
            const count = classCounts[className];
            const counterItem = document.createElement('div');
            counterItem.className = 'counter-item';
            counterItem.innerHTML = `
                <span class="counter-class">${className}</span>
                <span class="counter-count">${count}</span>
            `;
            counterItems.appendChild(counterItem);
        });
        
        counterContainer.style.display = 'block';
    }

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            tabs.forEach(t => t.classList.remove("active"));
            sections.forEach(s => s.classList.remove("active"));

            tab.classList.add("active");
            document.getElementById(tab.dataset.tab).classList.add("active");
        });
    });

    async function initializeCanvas() {
        if (!canvas) {
            canvas = document.createElement('canvas');
            canvas.style.display = 'block';
            canvas.style.maxWidth = '100%';
            canvas.style.height = 'auto';
            
            const resultContainer = document.getElementById('resultContainer');
            const resultImg = document.getElementById('resultImg');
            
            // Replace image with canvas
            resultImg.style.display = 'none';
            resultContainer.appendChild(canvas);
            
            ctx = canvas.getContext('2d');
        }
    }

    function drawImageWithFilter(selectedIds = null) {
        if (!originalImage || !canvas || !ctx) return;
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw original image
        ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
        
        detectionOverlays.forEach(overlay => {
            if (!selectedIds || selectedIds.includes(overlay.id)) {
                drawDetection(overlay);
            }
        });
    }

    function drawDetection(detection) {
        const { bbox, class: className, confidence, color, mask } = detection;
        
        // Scale factors
        const scaleX = canvas.width / originalImage.width;
        const scaleY = canvas.height / originalImage.height;

        const [x1, y1, x2, y2] = [
            bbox[0] * scaleX,
            bbox[1] * scaleY,
            bbox[2] * scaleX,
            bbox[3] * scaleY
        ];

        let bboxColor = '#ff0000'; // default
        let rgbColor = [255, 0, 0]; // default RGB values
        
        if (Array.isArray(color)) {
            bboxColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
            rgbColor = color;
        } else if (typeof color === 'string') {
            bboxColor = color;
            if (color.startsWith('#')) {
                const hex = color.replace('#', '');
                rgbColor = [
                    parseInt(hex.substring(0, 2), 16),
                    parseInt(hex.substring(2, 4), 16),
                    parseInt(hex.substring(4, 6), 16)
                ];
            }
        }

        if (mask) {
            const maskImg = new Image();
            maskImg.onload = function() {
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                tempCanvas.width = maskImg.width;
                tempCanvas.height = maskImg.height;
                
                tempCtx.drawImage(maskImg, 0, 0);
                
                const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i + 3] > 0) {
                        data[i] = rgbColor[0];
                        data[i + 1] = rgbColor[1];
                        data[i + 2] = rgbColor[2];
                    }
                }
                
                tempCtx.putImageData(imageData, 0, 0);
                ctx.globalAlpha = 0.8;
                ctx.drawImage(
                    tempCanvas, 
                    bbox[0], bbox[1], bbox[2] - bbox[0], bbox[3] - bbox[1],
                    x1, y1, x2 - x1, y2 - y1
                );
                ctx.globalAlpha = 1.0;
                ctx.strokeStyle = bboxColor;
                ctx.lineWidth = 2;
                ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
                ctx.fillStyle = bboxColor.replace(')', ', 0.7)').replace('rgb', 'rgba');
                ctx.fillRect(x1, y1 - 20, 150, 20);
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(`${className}: ${(confidence * 100).toFixed(1)}%`, x1 + 5, y1 - 5);
            };
            maskImg.src = "data:image/png;base64," + mask;
        } else {
            // Fallback if no mask
            ctx.strokeStyle = bboxColor;
            ctx.lineWidth = 2;
            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

            ctx.fillStyle = bboxColor.replace(')', ', 0.7)').replace('rgb', 'rgba');
            ctx.fillRect(x1, y1 - 20, 150, 20);

            ctx.fillStyle = 'white';
            ctx.font = '14px Arial';
            ctx.fillText(`${className}: ${(confidence * 100).toFixed(1)}%`, x1 + 5, y1 - 5);
        }
    }

    function prepareDetectionOverlays(detectionData) {
        return detectionData.map((detection) => {
            return {
                id: detection.id,
                class: detection.class,
                confidence: detection.confidence,
                bbox: detection.bbox,
                color: detection.color,
                mask: detection.mask || null
            };
        });
    }

    // Client-side filtering function
    function filterImage(selectedIds) {
        drawImageWithFilter(selectedIds);
    }

    document.getElementById("fileInput").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append("image", file);

        try {
            const response = await fetch("/predict", {
                method: "POST",
                body: formData
            });

            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            currentDetections = result.detections;
            currentImageData = result.annotated_image;
            currentDetectionData = result.detection_data || [];
            originalImageData = result.original_image;
            
            await initializeCanvas();
            
            // Load original image
            originalImage = new Image();
            originalImage.onload = function() {
                canvas.width = originalImage.width;
                canvas.height = originalImage.height;
                
                // Prepare detection overlays
                detectionOverlays = prepareDetectionOverlays(currentDetectionData);
                
                // Draw image with all detections
                drawImageWithFilter();
            };
            originalImage.src = "data:image/jpeg;base64," + originalImageData;
            
            // Update the detection cards
            updateDetectionCards(currentDetections);
            
            // Update detection counter
            updateDetectionCounter(currentDetections);
            
            // Update recommendations
            updateRecommendations(currentDetections);
            
        } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while processing the image: " + error.message);
        }
    });

    function updateDetectionCards(detections) {
        const container = document.getElementById("detectionsContainer");
        container.innerHTML = "";
        
        if (!detections || detections.length === 0) {
            container.innerHTML = `
                <div class="card">
                    <h3>No Issues Detected</h3>
                    <p>No dental issues were detected in this X-ray.</p>
                </div>
            `;
            return;
        }
        
        //filter controls
        const filterControls = document.createElement("div");
        filterControls.style.marginBottom = "15px";
        filterControls.innerHTML = `
            <button id="showAllBtn" class="filter-btn active" style="margin-right: 10px; padding: 8px 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Show All
            </button>
            <span style="font-weight: bold;">Filter by class:</span>
        `;
        container.appendChild(filterControls);
        
        //click event to Show All button
        document.getElementById("showAllBtn").addEventListener("click", () => {
            document.querySelectorAll(".class-filter-btn").forEach(btn => {
                btn.classList.remove("active");
            });
            document.getElementById("showAllBtn").classList.add("active");
            
            activeFilter = null;
            renderDetectionCards(currentDetections);
            
            // Show all detections on canvas
            filterImage(null);
            
        });
        
        // Create a card for each detection
        renderDetectionCards(detections);
        
        //class filter buttons
        const uniqueClasses = [...new Set(detections.map(d => d.class))];
        uniqueClasses.forEach(className => {
            const filterBtn = document.createElement("button");
            filterBtn.textContent = className;
            filterBtn.className = "class-filter-btn";
            filterBtn.style.margin = "5px";
            filterBtn.style.padding = "5px 10px";
            filterBtn.style.backgroundColor = "#ecf0f1";
            filterBtn.style.border = "none";
            filterBtn.style.borderRadius = "4px";
            filterBtn.style.cursor = "pointer";
            
            filterBtn.addEventListener("click", () => {
                document.querySelectorAll(".class-filter-btn").forEach(btn => {
                    btn.classList.remove("active");
                });
                document.getElementById("showAllBtn").classList.remove("active");
                filterBtn.classList.add("active");
                
                activeFilter = className;
                const filteredDetections = currentDetections.filter(d => d.class === className);
                renderDetectionCards(filteredDetections);
                
                // Filter image to show only this class
                const classIds = filteredDetections.map(d => d.id);
                filterImage(classIds);
                
            });
            
            filterControls.appendChild(filterBtn);
        });
    }

    function renderDetectionCards(detections) {
        const container = document.getElementById("detectionsContainer");
        
        // Remove existing cards (but keep filter controls)
        const filterControls = container.querySelector("div");
        const existingCards = container.querySelectorAll(".detection-card");
        existingCards.forEach(card => card.remove());
        
        if (!detections || detections.length === 0) {
            const noResults = document.createElement("div");
            noResults.className = "card";
            noResults.innerHTML = `
                <h3>No Matching Issues</h3>
                <p>No dental issues match the current filter.</p>
            `;
            container.appendChild(noResults);
            return;
        }
        
        //card creation
        detections.forEach((detection) => {
            const card = document.createElement("div");
            card.className = "detection-card";
            card.style.cursor = "pointer";
            card.style.transition = "all 0.3s ease";
            card.dataset.detectionId = detection.id;

            card.innerHTML = `
                <h4>${detection.class}</h4>
                <p><span class="types" data-type="${detection.types}">${detection.types}</span></p>
                <p>ID: ${detection.id}</p>
                <p>Description: ${detection.description}</p>
                <p>Confidence: <span class="confidence">${(detection.confidence * 100).toFixed(1)}%</span></p>
                <button class="focus-btn" style="margin-top: 10px; padding: 5px 10px; font-size: 12px; background-color: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; display: none;">
                </button>
            `;
            
            //click event for single
            const focusBtn = card.querySelector(".focus-btn");
            focusBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                
                const filteredDetections = currentDetections.filter(d => d.id === detection.id);
                renderDetectionCards(filteredDetections);
                
                document.querySelectorAll(".class-filter-btn").forEach(btn => {
                    btn.classList.remove("active");
                });
                document.getElementById("showAllBtn").classList.remove("active");
                
                //Filter image
                filterImage([detection.id]);
                
            });
            
            //click event for card
            card.addEventListener("click", () => {
                document.querySelectorAll('.detection-card').forEach(c => {
                    c.style.border = 'none';
                    c.style.backgroundColor = '';
                });
                
                if (card.style.border !== '2px solid #3498db') {
                    card.style.border = '2px solid #3498db';
                    card.style.backgroundColor = '#f0f8ff';
                    filterImage([detection.id]);
                } else {
                    card.style.border = 'none';
                    card.style.backgroundColor = '';
                    filterImage(null);
                }
            });
            
            //hover effect
            card.addEventListener("mouseenter", () => {
                card.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
                card.style.transform = "translateY(-2px)";
            });
            
            card.addEventListener("mouseleave", () => {
                if (card.style.border !== '2px solid #3498db') {
                    card.style.boxShadow = "0 2px 4px rgba(0, 0, 0, 0.1)";
                }
                card.style.transform = "translateY(0)";
            });
            
            container.appendChild(card);
        });
    }

    function updateRecommendations(detections) {
        const container = document.getElementById("recommendationsList");
        container.innerHTML = "";
        
        if (!detections || detections.length === 0) {
            container.innerHTML = `
                <p>No specific recommendations needed. Maintain good oral hygiene and regular checkups.</p>
            `;
            return;
        }
        
        const ul = document.createElement("ul");
        
        detections.forEach(detection => {
            const li = document.createElement("li");
            
            // Custom recommendations based on detection class
            const className = detection.class.toLowerCase();
            
            if (className.includes("caries") || className.includes("decay")) {
                li.textContent = `For ${detection.class}: Dental filling is recommended to prevent further decay.`;
            } else if (className.includes("crack") || className.includes("fracture")) {
                li.textContent = `For ${detection.class}: Dental crown may be needed to protect the tooth.`;
            } else if (className.includes("infection") || className.includes("lesion")) {
                li.textContent = `For ${detection.class}: Root canal treatment may be necessary.`;
            } else if (className.includes("missing")) {
                li.textContent = `For ${detection.class}: Consider dental implants or bridges.`;
            } else {
                li.textContent = `For ${detection.class}: Further examination by a dentist is recommended.`;
            }
            
            ul.appendChild(li);
        });
        
        const generalLi = document.createElement("li");
        generalLi.textContent = "Maintain improved oral hygiene practices and schedule regular dental visits.";
        ul.appendChild(generalLi);
        
        container.appendChild(ul);
    }
</script>
</body>
</html>